<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Booking HairSalon</title>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css-user/booknow.css} ">

</head>
<body>
<!--Login/Signup-->
<div th:replace="view/partials/popUpForms :: popUpForms"></div>
<!-- Header-->
<div th:replace="view/partials/header :: header"></div>
<div class="container-fluid">
    <div class="text-center">
        <h2 style="font-size:35px;">Booking HairSalon</h2>
    </div>

    <!-- Form -->
    <form th:action="@{/manageAppointments/save}" method="post" th:object="${appointment}">
        <div class="column">
            <div class="border-box">
                <div class="section-title" style="text-align:center;font-size:28px;">Customer Information</div>

                <!-- Customer Information -->
                <div class="form-group">
                    <label for="customer">Customer:</label>
                    <select id="customer" name="customerId" th:field="*{customer.user.id}" class="form-control" required>
                        <option value="" disabled selected>Select a customer</option>
                        <option th:each="customer : ${customerList}" th:value="${customer.user.id}" th:text="${customer.user.username}">
                        </option>
                    </select>
                    <input type="hidden" name="customerId" id="hidden-customer-id" />


                    <!-- Hiển thị ID khách hàng -->
                    <div id="customer-id-display" style="text-align:center; font-size:18px; margin-top:10px; display:none;">
                        Customer ID: <span id="customer-id"></span>
                    </div>
                </div>

                <!-- Thêm các trường ẩn cho thông tin khách hàng -->
                <input type="hidden" id="customerId" name="customerId" />
                <input type="hidden" id="customerEmail" name="customerEmail" />
                <input type="hidden" id="customerPhone" name="customerPhone" />

                <!-- Ngày đặt lịch -->
                <div class="form-group">
                    <label for="appointmentDate">Appointment Date:</label>
                    <input type="datetime-local" id="appointmentDate" th:field="*{appointmentDate}"
                           class="form-control" required />
                </div>
            </div>
        </div>

        <!-- Các trường thông tin dịch vụ -->
        <div class="column">
            <div class="border-box">
                <div class="section-title" style="text-align:center;font-size:28px; margin:15px 0;">Service Information</div>
                <div class="section-title" style="font-weight:bold;">Service</div>
                <div class="services-box">
                    <div th:each="care : ${careList}" class="service-item">
                        <!-- Checkbox dịch vụ -->
                        <input type="checkbox" th:field="*{cares}" th:value="${care.id}" id="service-${care.id}" style="display: none;" />

                        <!-- Label hiển thị thông tin dịch vụ -->
                        <label for="service-${care.id}" class="service-label">
                            <span th:text="${care.name}"></span>
                        </label>
                    </div>
                </div>


                <div class="border-box">
                    <div class="section-title" style="font-weight:bold;">Stylist</div>

                    <!-- Chọn stylist -->
                    <div class="form-group">
                        <select id="stylist" th:field="*{stylist.user.id}" class="form-control" required>
                            <option th:each="stylist : ${stylistList}" th:value="${stylist.user.id}"
                                    th:text="${stylist.user.username}"></option>
                        </select>
                    </div>
                    <div id="stylist-profile" style="display: none; margin-top: 20px;">
                        <h4>Stylist Profile</h4>
                        <div id="profile-details">
                            <!-- Nội dung profile sẽ được thêm ở đây -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nút Booking -->
            <div class="form-group text-center mt-3">
                <button type="submit" class="btn btn-success">Booking Appointment</button>
            </div>
        </div>
    </form>

</div>

<div th:replace="view/partials/footer :: footer"></div>


<script type="text/javascript">
    window.onload = function () {
        // Lấy customerId từ localStorage
        const customerId = localStorage.getItem('id');
        const customerIdDisplay = document.getElementById('customer-id');
        const customerIdDisplayContainer = document.getElementById('customer-id-display');

        if (customerId) {
            // Cập nhật và hiển thị ID khách hàng
            customerIdDisplay.textContent = customerId;
            customerIdDisplayContainer.style.display = 'block'; // Hiển thị ID khi có customerId

            // Tự động chọn khách hàng từ danh sách
            const customerSelect = document.getElementById('customer');
            const options = customerSelect.options;

            for (let i = 0; i < options.length; i++) {
                if (options[i].value === customerId) {
                    options[i].selected = true;
                    break;
                }
            }
        } else {
            // Nếu không có customerId, chuyển hướng đến trang đăng nhập
            alert('Please log in to make a booking.');
            window.location.href = 'http://localhost:8080/page/login';
            return;
        }

        // Xử lý khi người dùng chọn khách hàng từ dropdown
        const customerSelect = document.getElementById('customer');
        customerSelect.addEventListener('change', function () {
            const selectedCustomerId = this.value;
            customerIdDisplay.textContent = selectedCustomerId; // Cập nhật ID khách hàng
            customerIdDisplayContainer.style.display = 'block'; // Hiển thị ID khi có lựa chọn
        });

        // Xử lý chọn hoặc bỏ chọn dịch vụ
        const serviceItems = document.querySelectorAll('.service-item');
        serviceItems.forEach((item) => {
            const checkbox = item.querySelector('input[type="checkbox"]'); // Checkbox trong dịch vụ

            item.addEventListener('click', (event) => {
                if (event.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                item.classList.toggle('active', checkbox.checked);
                const selectedServices = Array.from(
                    document.querySelectorAll('.service-item input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);
                localStorage.setItem('selectedServices', selectedServices.join(','));
            });

            checkbox.addEventListener('change', () => {
                item.classList.toggle('active', checkbox.checked);
                const selectedServices = Array.from(
                    document.querySelectorAll('.service-item input[type="checkbox"]:checked')
                ).map((checkbox) => checkbox.value);
                localStorage.setItem('selectedServices', selectedServices.join(','));
            });
        });
    };

    // Hàm để hiển thị profile chi tiết của stylist khi chọn
    function displayStylistProfile(stylist) {
        const profileContainer = document.getElementById('stylist-profile');
        const profileDetails = document.getElementById('profile-details');

        profileContainer.style.display = 'flex';
        profileDetails.innerHTML = `
            <p><strong>${stylist.user.username}</strong></p>
            <p>Email: ${stylist.user.email || 'No email provided'}</p>
            <p>${stylist.description || 'No description available'}</p>
        `;
    }

    // Lắng nghe sự kiện submit của form để chắc chắn thông tin khách hàng và dịch vụ được gửi đúng
    document.querySelector('form').addEventListener('submit', function(event) {
        event.preventDefault();  // Ngừng form submit để kiểm tra dữ liệu

        // Lấy thông tin khách hàng
        const customerSelect = document.getElementById('customer');
        const customerId = customerSelect.value.trim();

        // Lấy danh sách dịch vụ đã chọn
        const selectedServices = Array.from(
            document.querySelectorAll('.service-item input[type="checkbox"]:checked')
        ).map((checkbox) => checkbox.value);

        if (customerId && selectedServices.length > 0) {
            // Gắn thông tin dịch vụ vào form
            const servicesInput = document.createElement('input');
            servicesInput.type = 'hidden';
            servicesInput.name = 'services';
            servicesInput.value = selectedServices.join(',');
            this.appendChild(servicesInput);
// Gửi form
            this.submit();
        } else {
            alert('Please ensure all customer details and at least one service are selected.');
        }
    });
</script>



</body>
</html>