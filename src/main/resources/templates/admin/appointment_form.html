<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Booking HairSalon</title>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css-user/booknow.css} ">
</head>
<body>
<!--Login/Signup-->
<div th:replace="view/partials/popUpForms :: popUpForms"></div>
<!-- Header-->
<div th:replace="view/partials/header :: header"></div>
<div class="container-fluid">
    <div class="text-center">
        <h2 style="font-size:35px;">Booking HairSalon</h2>
    </div>

    <!-- Form -->
    <form th:action="@{/manageAppointments/save}" method="post" th:object="${appointment}">
        <div class="column">
            <div class="border-box">
                <div class="section-title" style="text-align:center;font-size:28px;">Customer Information</div>

                <!-- Chọn khách hàng -->
                <div class="form-group">
                    <label for="customer">Customer:</label>
                    <input type="text" id="customer" class="form-control" readonly />
                    <input type="text" id="customerId" name="customerId" readonly/>
                </div>

                <!-- Ngày đặt lịch -->
                <div class="form-group">
                    <label for="appointmentDate">Appointment Date:</label>
                    <input type="datetime-local" id="appointmentDate" th:field="*{appointmentDate}"
                           class="form-control" required />
                </div>
            </div>
        </div>

        <!-- Các trường thông tin dịch vụ -->
        <div class="column">
            <div class="border-box">
                <div class="section-title" style="text-align:center;font-size:28px; margin:15px 0;">Service Information</div>
                <div class="section-title" style="font-weight:bold;">Service</div>
                <div class="services-box">
                    <div th:each="care : ${careList}" class="service-item">
                        <!-- Ẩn checkbox -->
                        <input type="checkbox" th:field="*{cares}" th:value="${care.id}" id="service-${care.id}" style="display: none;" />

                        <!-- Mở rộng vùng chọn và hiển thị label -->
                        <label for="service-${care.id}" class="service-label">
                            <div class="service-box-content">
                                <span th:text="${care.name}"></span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="border-box">
                    <div class="section-title" style="font-weight:bold;">Stylist</div>

                    <!-- Chọn stylist -->
                    <div class="form-group">
                        <select id="stylist" th:field="*{stylist.id}" class="form-control" required>
                            <option th:each="stylist : ${stylistList}" th:value="${stylist.id}"
                                    th:text="${stylist.user.username}"></option>
                        </select>
                    </div>
                    <div id="stylist-profile" style="display: none; margin-top: 20px;">
                        <h4>Stylist Profile</h4>
                        <div id="profile-details">
                            <!-- Nội dung profile sẽ được thêm ở đây -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nút Booking -->
            <div class="form-group text-center mt-3">
                <button type="submit" class="btn btn-success">Booking Appointment</button>
            </div>
        </div>
    </form>

</div>

<div th:replace="view/partials/footer :: footer"></div>

<script type="text/javascript">
    window.onload = function () {
        // Lấy thông tin khách hàng từ localStorage
        const customerInfo = {
            username: localStorage.getItem('username'),
            customerId: localStorage.getItem('id')  // Dùng 'id' từ localStorage thay vì 'customerId'
        };

        // Kiểm tra xem các giá trị đã được lấy chính xác từ localStorage chưa
        console.log(customerInfo);  // Debug log

        // Kiểm tra thông tin khách hàng và gán vào form
        if (customerInfo.username && customerInfo.customerId) {
            document.getElementById('customer').value = customerInfo.username;
            document.getElementById('customerId').value = customerInfo.customerId;
        } else {
            alert('Please log in to make a booking.');
            window.location.href = 'http://localhost:8080/page/login';
        }

        // Xử lý chọn hoặc bỏ chọn dịch vụ
        const serviceItems = document.querySelectorAll('.service-item');
        serviceItems.forEach((item) => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            item.addEventListener('click', (event) => {
                // Nếu không click vào checkbox mà click vào label hoặc vùng dịch vụ khác, thay đổi trạng thái của checkbox
                if (event.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('active', checkbox.checked);  // Thêm hoặc bỏ class 'active'
                }
            });

            // Đảm bảo rằng nếu click vào checkbox, trạng thái cũng thay đổi
            checkbox.addEventListener('change', () => {
                item.classList.toggle('active', checkbox.checked);
            });
        });
    };

    // Hàm hủy bỏ form và chuyển hướng
    function cancelForm() {
        window.location.href = '/manageAppointments';
    }

    // Hàm hiển thị thông tin stylist
    function displayStylistProfile(stylist) {
        const profileContainer = document.getElementById('stylist-profile');
        const profileDetails = document.getElementById('profile-details');

        profileContainer.style.display = 'flex';
        profileDetails.innerHTML = `
        <p><strong>${stylist.user.username}</strong></p>
        <p>Email: ${stylist.user.email || 'No email provided'}</p>
        <p>${stylist.description || 'No description available'}</p>
    `;
    }

    // Xử lý submit form
    document.querySelector('form').addEventListener('submit', function (event) {
        event.preventDefault();

        // Lấy thông tin khách hàng
        const customerName = document.getElementById('customer').value.trim();
        const customerId = document.getElementById('customerId').value.trim();

        // Lấy danh sách dịch vụ đã chọn
        const selectedServices = Array.from(
            document.querySelectorAll('.service-item input[type="checkbox"]:checked')
        ).map((checkbox) => checkbox.value);

        if (customerName && customerId && selectedServices.length > 0) {
            // Gắn thông tin dịch vụ vào form
            const servicesInput = document.createElement('input');
            servicesInput.type = 'hidden';
            servicesInput.name = 'services';
            servicesInput.value = selectedServices.join(',');
            this.appendChild(servicesInput);

            // Gửi form
            this.submit();
        } else {
            alert('Please ensure all customer details and at least one service are selected.');
        }
    });

</script>

</body>
</html>
